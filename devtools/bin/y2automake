#!/bin/sh
#
# y2automake - generate YaST2 "Makefile.am"
# toplevel directory: from template and ./SUBDIRS
# po directory: from Makefile.am.top, template and Makefile.am.bottom
#
# Author: Stefan Hundhammer <sh@suse.de>
# (c) SuSE GmbH 2001
#
# $Id$
#


#
# Append the contents of file $src to file $target.
#
# Parameters:
#	$src	Source file name
#	$target	Target file name
#
function append_lines()
{
    src=$1
    target=$2

    echo "# --- START lines from $src ---"	>>$target
    cat $src					>>$target
    echo "# --- END lines from $src ---"	>>$target
}


#
# Init
#

self=`basename $0`
y2adminpath=/usr/share/YaST2/devtools/admin

if [ "$1" == "--bootstrap" ]; then
    y2adminpath=$2
fi


#
# Generate toplevel Makefile.am
#

template=$y2adminpath/Makefile.am.toplevel

RPMNAME=`cat ./RPMNAME`

if [ ! -e VERSION ]; then
    echo "${self} ERROR: Start this only in YaST2 toplevel project directories!" >&2
    exit 1
fi

if [ ! -e SUBDIRS ]; then
    subdirs=`ls */Makefile.am | sed -e 's:/Makefile.am::' | sort | grep -v "^$RPMNAME-" | tr '\n' ' '`
    comment="No ./SUBDIRS file found - assuming default: All direct subdirs with Makefile.am"

    if [ -z "$subdirs" ]; then
        echo "${self} ERROR: No ./SUBDIRS file and no subdir with a \"Makefile.am\"" >&2
        exit 2
    fi
else
    subdirs=`cat SUBDIRS | sed -e 's/SUBDIRS *= *//'`
    comment="Contents of ./SUBDIRS"
fi

if [ ! -e $template ]; then
    echo "${self} ERROR: Can't find $template" >&2
    exit 3
fi

# if [ -e Makefile.am ]; then
#     mv Makefile.am ${result}.old
# fi

echo "${self}: Generating toplevel Makefile.am"
cp $template Makefile.am

test -z "$comment" || echo "# $comment" >>Makefile.am
echo "SUBDIRS = $subdirs" >>Makefile.am



#
# Generate po/Makefile.am
#

if [ x"yast2-trans" = x$(cat RPMNAME | sed 's:\(yast2-trans\).*:\1:') -a \
     -d po ]; then

    po_adminpath=$y2adminpath/po

    if [ -e po/Makefile.am.top ]; then
        top_part=po/Makefile.am.top
    else
	top_part=$po_adminpath/Makefile.am.top
    fi

    center_part=$po_adminpath/Makefile.am.center

    if [ -e po/Makefile.am.bottom ]; then
	bottom_part=po/Makefile.am.bottom
    else
	bottom_part=$po_adminpath/Makefile.am.bottom
    fi

    target=po/Makefile.am

    echo "${self}: Generating po/Makefile.am from"
    echo "    $top_part"
    echo "    $center_part"
    echo "    $bottom_part"

    cat >$target <<'EOF'
# Emacs: -*- makefile -*-
#
# Makefile.am for a YaST2 translation (po/) subproject
#
# -- This file is generated by y2automake - DO NOT EDIT! --
#
EOF

    append_lines $top_part	$target
    append_lines $center_part	$target
    append_lines $bottom_part	$target

fi
